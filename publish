#!/usr/bin/env bash
# https://www.cirosantilli.com#how-to-develop-ciro-santillis-website
set -eux
root="$(pwd)"
mkdir -p out
# We maintain a safety clone in this directory,
# to avoid leaking .gitignored files through Jekyll.
cd out
if [ ! -d .git ]; then
  git clone --recursive .. .
else
  git pull
  git submodule update --init
fi
./build
git -C "$root" push
cp \
  Gemfile \
  Gemfile.lock \
  _config.yml \
  _site/ \
;
cd _site
if [ ! -d .git ]; then
  git init
  git remote add origin git@github.com:cirosantilli/cirosantilli.github.io.git
  git fetch origin
  git reset origin/master
fi
git add .
git commit -m "$(git -C .. log -n1 --pretty='%H' dev)"
git push origin master:master
