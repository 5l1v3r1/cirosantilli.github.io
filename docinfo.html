<script>
<!-- Google Analytics, AKA selling my soul to Google for some backlinks. -->
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-47867706-1', 'auto');
ga('send', 'pageview');

// Load required scripts dynamically:
//
// * https://stackoverflow.com/questions/7308908/waiting-for-dynamically-loaded-script/57267538#57267538
// * https://stackoverflow.com/questions/14521108/dynamically-load-js-inside-js/14521482#14521482
// * https://stackoverflow.com/questions/10004112/how-can-i-wait-for-set-of-asynchronous-callback-functions
//
// We use to reduce the initial load time.
//
// Each script is loaded only once after it has finished loading for the first time,
// even if this function is called multiple times.
async function cirosantilli_load_scripts(script_urls) {
    function load(script_url) {
        return new Promise(function(resolve, reject) {
            if (cirosantilli_load_scripts.loaded.has(script_url)) {
                resolve();
            } else {
                var script = document.createElement('script');
                script.onload = resolve;
                script.src = script_url
                document.head.appendChild(script);
            }
        });
    }
    var promises = [];
    for (const script_url of script_urls) {
        promises.push(load(script_url));
    }
    await Promise.all(promises);
    for (const script_url of script_urls) {
        cirosantilli_load_scripts.loaded.add(script_url);
    }
}
cirosantilli_load_scripts.loaded = new Set();

// Create some nice controls for a canvas demo!
//
// `draw_func(ctx, width, height, time)`:
//
// * ctx: canvas context
// * width, height: integers
// * time: integer time step
// * inputs: map of custom GUI inputs for this demo, to be shown
// next to generic demo parameters like enable and max FPS.
// E.g. {"one_param_id": {"default": 1, "type": "number"}}
// +
// ....
// {'pixel_size': {'label': 'Pixel size', 'attributes': {'default': 1, 'type': 'number'}}}
// ....
// * init_func: if undefined, called once when the script first loads
function cirosantilli_create_canvas_demo(demo_id, draw_func, inputs, init_func) {
    (async () => {
    // Random variables.
    var canvas_demo_prefix = 'canvas-demo';
    var this_demo_prefix = '${canvas_demo_prefix}_${demo_id}';
    var time = 0;
    var fps_limit_last_render = Date.now();
    // https://stackoverflow.com/questions/19764018/controlling-fps-with-requestanimationframe
    var now, fps_limit_then, fps_limit_elapsed;
    fps_limit_then = Date.now();
    var fps_last_date = new Date();
    var canvas_width_input = document.getElementById(`${this_demo_prefix}_width-input`);

    // HTML.
    var canvas_wrapper = document.createElement('div');
    canvas_wrapper.setAttribute('class', canvas_demo_prefix);
    document.currentScript.parentNode.insertBefore(canvas_wrapper, document.currentScript);

    // Enable disable.
    var enable_input = document.createElement('input');
    enable_input.setAttribute('type', 'checkbox');
    enable_input.setAttribute('value', '5');
    enable_input.setAttribute('min', '1');
    enable_input.addEventListener('change', async () => {
        init();
    });
    var enable_label = document.createElement('label');
    enable_label.appendChild(document.createTextNode('Enable: '));
    enable_label.appendChild(enable_input);
    enable_label.appendChild(document.createTextNode('<-- (click this to run!!!)'));
    var enable_div = document.createElement('div');
    enable_div.appendChild(enable_label);
    canvas_wrapper.appendChild(enable_div);

    //function add_input_after_enable(input_attributes) {
    //    var input = 
    //    for 
    //}

    //var canvas_width_input = add_input_after_enable();

    // Canvas width.
    var canvas_width_input = document.createElement('input');
    canvas_width_input.setAttribute('type', 'number');
    canvas_width_input.setAttribute('value', '128');
    canvas_width_input.setAttribute('min', '1');
    var canvas_width_div = document.createElement('div');
    canvas_width_div.appendChild(document.createTextNode('canvas width: '));
    canvas_width_div.appendChild(canvas_width_input);

    canvas_wrapper.appendChild(canvas_width_div);

    // Save images.
    var save_images_input = document.createElement('input');
    save_images_input.setAttribute('type', 'checkbox');
    save_images_input.setAttribute('value', '5');
    save_images_input.setAttribute('min', '1');
    var save_images_div = document.createElement('div');
    save_images_div.appendChild(document.createTextNode('Save images: '));
    save_images_div.appendChild(save_images_input);
    canvas_wrapper.appendChild(save_images_div);

    // FPS limit
    var fps_limit_input = document.createElement('input');
    fps_limit_input.setAttribute('type', 'number');
    fps_limit_input.setAttribute('min', '1');
    var fps_limit_div = document.createElement('div');
    fps_limit_div.appendChild(document.createTextNode('FPS limit: '));
    fps_limit_div.appendChild(fps_limit_input);
    canvas_wrapper.appendChild(fps_limit_div);

    // FPS granule
    var fps_granule_input = document.createElement('input');
    fps_granule_input.setAttribute('type', 'number');
    fps_granule_input.setAttribute('value', '5');
    fps_granule_input.setAttribute('min', '0');
    var fps_granule_div = document.createElement('div');
    fps_granule_div.appendChild(document.createTextNode('FPS granule: '));
    fps_granule_div.appendChild(fps_granule_input);
    canvas_wrapper.appendChild(fps_granule_div);

    // Total frames
    var total_frames_span = document.createElement('span');
    total_frames_span.innerHTML = time.toString();
    var total_frames_div = document.createElement('div');
    total_frames_div.appendChild(document.createTextNode('Total frames: '));
    total_frames_div.appendChild(total_frames_span);
    canvas_wrapper.appendChild(total_frames_div);

    // FPS
    var fps_span = document.createElement('span');
    var fps_div = document.createElement('div');
    fps_div.appendChild(document.createTextNode('FPS: '));
    fps_div.appendChild(fps_span);
    canvas_wrapper.appendChild(fps_div);

    // Canvas.
    var canvas = document.createElement('canvas');
    canvas.setAttribute('style', 'border:1px solid black;');
    canvas_wrapper.appendChild(canvas);
    var ctx = canvas.getContext('2d');

    // We need this to fix time because toBlob calls are asynchronous.
    function createBlobFunc(time) {
        return (blob) => {
            // From FileSaver.js.
            saveAs(blob, 'canvas-' + time.toString() + '.png');
        };
    }

    function resizeCanvas() {
        var canvas_width = parseInt(canvas_width_input.value);
        if (isNaN(canvas_width)) {
            canvas_width = parseInt(canvas_width_input.getAttribute('value'));
        }
        canvas.width = canvas_width;
        canvas.height = canvas_width;
    }

    function animate() {
        var fps_limit = parseFloat(fps_limit_input.value);
        if (!isNaN(fps_limit)) {
            var fps_limit_time_millis = 1000.0 / fps_limit;
            now = Date.now();
            fps_limit_elapsed = now - fps_limit_then;
        }
        if (isNaN(fps_limit) || (fps_limit_elapsed > fps_limit_time_millis)) {
            if (!isNaN(fps_limit)) {
                fps_limit_then = now - (fps_limit_elapsed % fps_limit_time_millis);
            }
            resizeCanvas();

            // The actual drawing.
            draw_func(ctx, canvas.width, canvas.height, time);

            // Save the images to files.
            // https://stackoverflow.com/questions/19235286/convert-html5-canvas-sequence-to-a-video-file/57153718#57153718
            if (save_images_input.checked) {
                canvas.toBlob(createBlobFunc(time));
            }
            time++;
            total_frames_span.innerHTML = time.toString();
            fps_limit_last_render = Date.now();

            /* FPS calculation. */
            var fps_granule = parseInt(fps_granule_input.value);
            if (time % fps_granule == 0) {
                var fps_date = Date.now();
                fps_span.innerHTML = (1000.0 * fps_granule / (fps_date - fps_last_date)).toFixed(2);
                fps_last_date = fps_date;
            }
        }
        if (enable_input.checked) {
            window.requestAnimationFrame(animate);
        }
    }

    async function init() {
        if (enable_input.checked) {
            if (!init.init) {
                await cirosantilli_load_scripts(['https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js']);
                init.init = true;
            }
            window.requestAnimationFrame(animate);
        };
    }
    init.init = false;

    resizeCanvas();
    await init();
    if (inputs !== undefined) {
    }
    if (init_func !== undefined) {
        init_func(canvas_wrapper);
    }
    })();
}

</script>
<link rel="shortcut icon" type="image/x-icon" href="/ciro-santilli-id-photo-2013.jpg" />
<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css"/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css"
  crossorigin="anonymous"
  integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j"
>
<style>
body {
  padding-left: 10px;
}
label {
    font-weight: normal !important;
}
.imageblock {
  margin-bottom: 10px;
}
.canvas-demo {
  border: 1px solid black;
  padding-left: 5px;
  padding-right: 5px;
  margin-bottom: 10px;
}
/* Custom style. */
</style>
